<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload with Free-form Cropping</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/css/jquery.fileupload.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        #cropper-container {
            max-width: 100%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #cropper-image {
            max-width: 100%;
            max-height: 80vh; /* Ensure it doesn't exceed viewport height */
            display: block;
        }

        #crop-button {
            margin-top: 10px;
        }

        #progress {
            margin-top: 10px;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
        }
    </style>
</head>
<body>
    <input id="fileupload" type="file" name="files[]" multiple>
    <div id="cropper-container">
        <img id="cropper-image" style="display: none;" />
    </div>
    <button id="crop-button" style="display: none;">Crop and Upload</button>
    <div id="progress">
        <div class="progress-bar"></div>
    </div>
    <div id="files" class="files"></div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/vendor/jquery.ui.widget.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-load-image/5.16.0/load-image.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-canvas-to-blob/3.28.0/js/canvas-to-blob.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.iframe-transport.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload-process.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload-image.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload-audio.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload-video.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/10.32.0/js/jquery.fileupload-validate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        $(function () {
            var cropper;
            var cropperImage = $('#cropper-image');
            var cropButton = $('#crop-button');

            $('#fileupload').fileupload({
                dataType: 'json',
                add: function (e, data) {
                    var file = data.files[0];
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        cropperImage.attr('src', e.target.result).show();
                        cropButton.show();

                        if (cropper) {
                            cropper.destroy();
                        }

                        cropper = new Cropper(cropperImage[0], {
                            aspectRatio: NaN, // Free-form cropping
                            viewMode: 1,
                            autoCropArea: 1,
                            responsive: true,
                            restore: true,
                            modal: true,
                            guides: true,
                            highlight: true,
                            cropBoxMovable: true,
                            cropBoxResizable: true,
                            background: false,
                        });
                    };

                    reader.readAsDataURL(file);

                    cropButton.off('click').on('click', function () {
                        var croppedCanvas = cropper.getCroppedCanvas();
                        croppedCanvas.toBlob(function (blob) {
                            var formData = new FormData();
                            formData.append('files[]', blob, file.name);  // Ensure 'files[]' matches server-side script expectation

                            $.ajax({
                                url: 'https://quantumcloud.ng/techcamp2024/api/image/',
                                type: 'POST',
                                contentType: false,
                                processData: false,
                                data: formData,
                                success: function (response) {
                                    console.log('Upload successful!');
                                    $.each(response.files, function (index, file) {
                                        $('<p/>').text(file.name).appendTo('#files');
                                    });
                                },
                                error: function (xhr, status, error) {
                                    console.error('Upload failed: ' + error);
                                }
                            });
                        });
                    });
                },
                done: function (e, data) {
                    $.each(data.result.files, function (index, file) {
                        $('<p/>').text(file.name).appendTo('#files');
                    });
                },
                progressall: function (e, data) {
                    var progress = parseInt(data.loaded / data.total * 100, 10);
                    $('#progress .progress-bar').css('width', progress + '%');
                }
            });
        });
    </script>
</body>
</html>